defaults: &defaults
  docker:
    - image: circleci/node:12
      environment:
        ## this enables colors in the output
        TERM: xterm
version: 2.1
jobs:
  deploy-code:
    << : *defaults
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-deps-{{ .Branch }}-{{ checksum "pnpm-lock.yaml" }}
            - v1-deps-{{ .Branch }}-
            - v1-deps-
      - run:
          name: Install tooling
          command: |
            sudo apt-get -y -qq install awscli dnsutils
            sudo npm install -g pnpm
            sudo npm install -g serverless
      - run:
          name: Install dependencies
          command: |
            pnpm install
      - save_cache:
          key: v1-deps-{{ .Branch }}-{{ checksum "pnpm-lock.yaml" }}
          paths:
            - ~/project/node_modules
      - run:
          name: pnpm run lint
          command: |
            cd ~/project/solution/ui
            pnpm run lint
      - run:
          name: Run test
          command: |
            cd ~/project/solution/ui
            pnpm run test
      - run:
          name: Deploy the code
          requires:
            Install dependencies
          command: |
             serverless config credentials --provider aws --profile SBA-lower --key ${AWS_ACCESS_KEY_ID} --secret ${AWS_SECRET_ACCESS_KEY}
             cd scripts
             if [[ "master" == "${CIRCLE_BRANCH}" ]]; 
               then export TARGET="bec-staging"; 
             elseif [[ "develop" == "${CIRCLE_BRANCH}" ]]
               then export TARGET="bec-develop"
             else export TARGET="${CIRCLE_USERNAME}"; fi
             source ./environment-deploy.sh ${TARGET}

workflows:
  version: 2.1
  build:
    jobs:
      - deploy-code:
          context: sba-gov-lower
